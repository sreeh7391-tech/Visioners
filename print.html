<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visioners: Image to Braille</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/2.1.1/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --accent:#2b6ef6; --print:#ff9800;
    }
    body{
      background:var(--bg);
      font-family:Inter, Roboto, Arial, sans-serif;
      margin:0; padding:28px; display:flex; align-items:flex-start; justify-content:center;
    }
    .card{
      width:100%; max-width:900px; background:var(--card); border-radius:12px;
      box-shadow:0 6px 30px rgba(20,30,60,0.08); padding:22px;
    }
    header{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    h1{margin:0; font-size:20px;}
    .controls{display:flex; gap:12px; align-items:center; flex-wrap:wrap;}
    .drop{
      border:2px dashed #d7dbe8; border-radius:10px; padding:18px; text-align:center;
      display:flex; align-items:center; justify-content:center; gap:12px; cursor:pointer;
      background:linear-gradient(180deg, rgba(250,251,255,0.6), transparent);
      width:100%; min-height:160px;
    }
    input[type=file]{display:none;}
    #preview{max-width:320px; max-height:320px; border-radius:8px; display:block; margin:auto;}
    .row{display:flex; gap:16px; margin-top:14px; align-items:flex-start;}
    .col{flex:1;}
    
    /* Button Styles */
    button{
      background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:8px;
      cursor:pointer; font-weight:600; transition: 0.2s;
    }
    button:disabled{opacity:0.6; cursor:not-allowed;}
    
    /* Specific style for Print Button */
    #printBtn { background: var(--print); }
    #printBtn:hover { background: #e68900; }

    select{padding:8px;border-radius:8px;border:1px solid #d6d9ec;}
    .status{font-size:13px; color:#334055; margin-top:8px;}
    pre{
      background:#0f1724; color:#e6eef8; padding:14px; border-radius:8px; overflow:auto;
      max-height:360px; white-space:pre-wrap; word-break:break-word; font-family:monospace; font-size:13px;
    }
    footer{margin-top:14px; font-size:13px; color:#404b66;}
    .small{font-size:12px; color:#556;}
  </style>
</head>
<body>
  <div class="card" role="main">
    <header>
      <div>
        <h1>Image → Braille</h1>
        <div class="small">1. Upload Image (Web) → 2. Connect to Printer WiFi → 3. Print</div>
      </div>

      <div class="controls">
        <label for="lang">Language</label>
        <select id="lang">
          <option value="eng" selected>English</option>
        </select>
        <button id="clearBtn" type="button" style="background:#888;">Clear</button>
      </div>
    </header>

    <section style="margin-top:14px;">
      <label class="drop" id="dropZone">
        <div style="max-width:720px;">
          <strong>Drag & Drop an image here</strong>
          <div class="small">or click to choose a file</div>
          <input id="fileInput" type="file" accept="image/*">
        </div>
      </label>

      <div class="row">
        <div class="col" style="max-width:360px;">
          <img id="preview" style="display:none">
          <div class="status" id="status">No image loaded.</div>
          <div style="margin-top:10px;">
            <button id="ocrBtn" disabled>Extract Text</button>
          </div>
        </div>

        <div class="col">
          <div style="margin-bottom:8px; font-weight:600; display:flex; justify-content:space-between;">
             <span>Recognized Text</span>
             <button id="printBtn" disabled>Print to Braille</button>
          </div>
          <pre id="output">— results will appear here —</pre>
          <div style="text-align:right; margin-top:5px;">
            <button id="downloadBtn" disabled style="background:#556; font-size:12px;">Save .txt</button>
          </div>
        </div>
      </div>
    </section>

    <footer>
      <div class="small">Visioners Braille Project</div>
    </footer>
  </div>

  <script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const ocrBtn = document.getElementById('ocrBtn');
    const statusEl = document.getElementById('status');
    const output = document.getElementById('output');
    const clearBtn = document.getElementById('clearBtn');
    const langSelect = document.getElementById('lang');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');

    let currentDataUrl = null;

    function setStatus(t){ statusEl.textContent = t; }
    function enableOCR(enable){
      ocrBtn.disabled = !enable;
      downloadBtn.disabled = true;
      printBtn.disabled = true;
    }

    ['dragenter','dragover'].forEach(e=>{
      dropZone.addEventListener(e, ev=>{ ev.preventDefault(); dropZone.style.borderColor='#a9b6ff'; });
    });
    ['dragleave','drop'].forEach(e=>{
      dropZone.addEventListener(e, ev=>{ ev.preventDefault(); dropZone.style.borderColor=''; });
    });

    dropZone.addEventListener('click', ()=> fileInput.click());
    dropZone.addEventListener('drop', async (ev)=>{
      ev.preventDefault();
      const file = ev.dataTransfer.files?.[0];
      if(file) handleFile(file);
    });

    fileInput.addEventListener('change', ()=> handleFile(fileInput.files?.[0]));

    clearBtn.addEventListener('click', ()=>{
      fileInput.value='';
      preview.src='';
      preview.style.display='none';
      output.textContent='— results will appear here —';
      setStatus('No image loaded.');
      currentDataUrl = null;
      enableOCR(false);
    });

    async function handleFile(file){
      if(!file.type.startsWith('image/')){ alert('Select an image file.'); return; }
      setStatus('Loading image...');
      output.textContent='— results will appear here —';

      const dataUrl = await new Promise(res=>{
        const fr = new FileReader();
        fr.onload = ()=>res(fr.result);
        fr.readAsDataURL(file);
      });

      currentDataUrl = dataUrl;
      preview.src = dataUrl;
      preview.style.display = 'block';
      setStatus('Image loaded.');
      enableOCR(true);
    }

    ocrBtn.addEventListener('click', async ()=>{
      if(!currentDataUrl) return;
      setStatus('Starting OCR... (Needs Internet)');
      ocrBtn.disabled = true;

      try{
        const worker = Tesseract.createWorker({
          logger: m => setStatus(`${m.status} ${(m.progress*100|0)}%`)
        });

        const lang = langSelect.value;

        await worker.load();
        await worker.loadLanguage(lang);
        await worker.initialize(lang);

        const { data } = await worker.recognize(currentDataUrl);
        
        // Clean up text (remove excessive newlines for the printer)
        let cleanText = data.text.replace(/(\r\n|\n|\r)/gm, " ");
        output.textContent = cleanText || '— No text found —';

        downloadBtn.disabled = false;
        printBtn.disabled = false; // Enable Print Button
        
        await worker.terminate();
        setStatus('OCR complete. Connect to Printer WiFi now.');
      }catch(err){
        output.textContent = 'Error: ' + err.message;
        setStatus('Error during OCR.');
      }

      ocrBtn.disabled = false;
    });

    downloadBtn.addEventListener('click', ()=>{
      const text = output.textContent;
      const blob = new Blob([text], {type:'text/plain'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ocr-output.txt';
      a.click();
    });

    // --- NEW: PRINT TO BRAILLE FUNCTION ---
    printBtn.addEventListener('click', () => {
        const textToPrint = output.textContent.trim();

        if (!textToPrint || textToPrint === '— No text found —') {
            alert("No text to print!");
            return;
        }

        // Warning: Based on your Arduino code, long strings might get cut off
        // or you might need to increase the buffer size in your Arduino code.
        
        // Construct URL for ESP8266
        var espAddress = "http://192.168.4.1/print";
        var fullUrl = espAddress + "?text=" + encodeURIComponent(textToPrint);

        setStatus("Sending to Printer...");

        fetch(fullUrl)
        .then(response => {
            if (response.ok) {
                alert("Sent to Braille Printer!");
                setStatus("Sent successfully.");
            } else {
                alert("Connected, but printer returned an error.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert("Connection Failed!\n\n1. Go to Phone Settings.\n2. Connect WiFi to 'Braille_Printer_AP'.\n3. Come back and click Print again.");
            setStatus("Connection failed. Check WiFi.");
        });
    });

    enableOCR(false);
  </script>
</body>
</html>